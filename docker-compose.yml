version: "3.9"

services:
  cache:
    container_name: cache
    image: redis:alpine
    volumes:
      - ./trias-extractor/data:/data
    entrypoint: ["redis-server", "--appendonly", "yes"]

  trias-extractor:
    container_name: trias-extractor
    build:
      context: ./trias-extractor/
      dockerfile: Dockerfile.production
    environment:
      FLASK_ENV: production
    depends_on:
      - cache

  time-fc:
    container_name: time-fc
    build: ./time-fc/
    volumes:
       # we need to mount a single file, not to overwrite the whole folder
      - ./time-fc/time-fc.py:/code/time-fc.py
    environment:
      FLASK_ENV: development
    depends_on:
      - cache

  weather-fc:
    container_name: weather-fc
    build: ./weather-fc
    volumes:
      - ./weather-fc/weather.py:/code/weather.py
    environment:
      FLASK_ENV: development
    link:
      - owm_proxy

  owm_proxy:
    container_name: owm_proxy
    build: ./weather-fc/owm_proxy
    volumes:
      - ./weather-fc/owm_proxy/owm_proxy.py:/code/owm_proxy.py
    environment:
      FLASK_ENV: development
    depends_on:
      - weather-fc

  price-fc:
    container_name: price-fc
    build: ./price-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache

  traffic-fc:
    container_name: traffic-fc
    build: ./traffic-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache

  enviromental-fc:
    container_name: enviromental-fc
    build: ./enviromental-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache
      
  position-fc:
    container_name: position-fc
    build: ./position-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache
      
  active-fc:
    container_name: active-fc
    build: ./active-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache
      
  tsp-fc:
    container_name: tsp-fc
    build: ./tsp-fc
    environment:
      FLASK_ENV: production
    depends_on:
      - cache
      
  panoramic-fc:
    container_name: panoramic-fc
    build: ./panoramic-fc
    volumes:
      - ./panoramic-fc/utils.py:/code/utils.py
      - ./panoramic-fc/panoramic.py:/code/panoramic.py
    environment:
      FLASK_ENV: development
    depends_on:
      - cache

  oc-core:
    container_name: oc-core
    build: ./oc-core/
    environment:
      FLASK_ENV: development
    volumes:
      - ./oc-core/oc-core.py:/code/oc-core.py
      - ./oc-core/oc-core.conf:/code/oc-core.conf
      - ./oc-core/determinant_factors.py:/code/determinant_factors.py
    ports:
      - 5000:5000
    depends_on:
      - cache
    link;
      - trias-extractor
      - cache
      - active-fc
      - enviromental-fc
      - panoramic-fc
      - position-fc
      - price-fc
      - time-fc
      - traffic-fc
      - tsp-fc
      - weather-fc
